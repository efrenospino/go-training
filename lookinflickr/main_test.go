package main

import (
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
)

const htmlSearch = `<input type="text" placeholder="Type something..." name="text" class="form-control" value="">`

//const url = "https://api.flickr.com/services/rest/?api_key=0a97e077103df1244029fdab72379f39&method=flickr.photos.search&text=carnaval%20de%20barranquilla&media=jpg&format=json&per_page=50&tags=carnaval%20de%20barranquilla"

const flickrJSON = `jsonFlickrApi({"photos":{"page":1,"pages":135,"perpage":50,"total":"6724","photo":[{"id":"24313949581","owner":"131853325@N03","secret":"b968964e51","server":"1563","farm":2,"title":"Carnaval de Barranquilla 2016: la gran fiesta de Colombia","ispublic":1,"isfriend":0,"isfamily":0},{"id":"20854464483","owner":"127055090@N04","secret":"518870eacd","server":"5772","farm":6,"title":"Bailar contigo","ispublic":1,"isfriend":0,"isfamily":0},{"id":"20852831714","owner":"127055090@N04","secret":"5e1762a16e","server":"5655","farm":6,"title":"Tu mirada","ispublic":1,"isfriend":0,"isfamily":0},{"id":"21288609569","owner":"127055090@N04","secret":"2933e73bb9","server":"717","farm":1,"title":"Young on parada","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17308805275","owner":"127055090@N04","secret":"de494b55f1","server":"7698","farm":8,"title":"Trio","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17308791505","owner":"127055090@N04","secret":"92a9b2d450","server":"7705","farm":8,"title":"Carnaval de Barranquilla","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17306929652","owner":"127055090@N04","secret":"955622a71b","server":"8787","farm":9,"title":"Pretty smile Dancer","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16547483384","owner":"131549499@N06","secret":"9a57096db5","server":"8791","farm":9,"title":"100_2320","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16962481477","owner":"131549499@N06","secret":"71a63ef393","server":"8806","farm":9,"title":"100_2318","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17143952976","owner":"131549499@N06","secret":"bdfc8616e2","server":"8744","farm":9,"title":"100_2316","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982115188","owner":"131549499@N06","secret":"9a4f8bf05f","server":"8813","farm":9,"title":"100_2314-001","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169244221","owner":"131549499@N06","secret":"9c6a5cc5c5","server":"7670","farm":8,"title":"100_2312","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169233671","owner":"131549499@N06","secret":"8aac69b655","server":"7693","farm":8,"title":"100_2311","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169220341","owner":"131549499@N06","secret":"7891fdde42","server":"7692","farm":8,"title":"100_2307","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982289690","owner":"131549499@N06","secret":"53262ff528","server":"8812","farm":9,"title":"100_2304","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16549647293","owner":"131549499@N06","secret":"3d08959f38","server":"8735","farm":9,"title":"100_2301","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17168165532","owner":"131549499@N06","secret":"71df4b207d","server":"8745","farm":9,"title":"100_2299","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982255230","owner":"131549499@N06","secret":"eababd5fa9","server":"8789","farm":9,"title":"100_2296","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16549613113","owner":"131549499@N06","secret":"3020cecf3c","server":"8768","farm":9,"title":"100_2294","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16962359017","owner":"131549499@N06","secret":"65d714b221","server":"7611","farm":8,"title":"100_2292","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982225080","owner":"131549499@N06","secret":"2a6d5b970a","server":"7717","farm":8,"title":"100_2291","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169135171","owner":"131549499@N06","secret":"abb08a3d18","server":"8718","farm":9,"title":"100_2289","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17143773966","owner":"131549499@N06","secret":"93106cd772","server":"7599","farm":8,"title":"100_2273","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982082650","owner":"131549499@N06","secret":"4a5ac7ed86","server":"8689","farm":9,"title":"100_2306-001","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16655642650","owner":"127055090@N04","secret":"b52bccd1e3","server":"8615","farm":9,"title":"Hola guapita!","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16842713485","owner":"127055090@N04","secret":"02f251151f","server":"7283","farm":8,"title":"Public intimacy","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16577012727","owner":"127055090@N04","secret":"13b2b7b05f","server":"7606","farm":8,"title":"Muevete!","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16122121144","owner":"29903860@N05","secret":"797074b3dc","server":"8637","farm":9,"title":"Carnaval de Barranquilla","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16540452868","owner":"127055090@N04","secret":"3a95b35d25","server":"8666","farm":9,"title":"Don't you know what's coming?","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16410106100","owner":"51851393@N04","secret":"151d6fdf4d","server":"8634","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16411288549","owner":"51851393@N04","secret":"7f63a74c64","server":"7395","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16409913088","owner":"51851393@N04","secret":"6709da1026","server":"8586","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16411287649","owner":"51851393@N04","secret":"2461394412","server":"7362","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"15974960584","owner":"51851393@N04","secret":"c48fb1fa50","server":"7292","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16411286539","owner":"51851393@N04","secret":"cfeba08f36","server":"7408","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"15974959294","owner":"51851393@N04","secret":"d19250cb65","server":"7427","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16596499262","owner":"51851393@N04","secret":"d13656f728","server":"7282","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16571138196","owner":"51851393@N04","secret":"f8fa197ec2","server":"8628","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16571137626","owner":"51851393@N04","secret":"0381a3878d","server":"7288","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16571137146","owner":"51851393@N04","secret":"fe08dd8d49","server":"7375","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16595936421","owner":"51851393@N04","secret":"478b949360","server":"7423","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16595935851","owner":"51851393@N04","secret":"f915e1cc5a","server":"8566","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16597118535","owner":"51851393@N04","secret":"d8edf7c35f","server":"7339","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16596495512","owner":"51851393@N04","secret":"9710279b78","server":"7286","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16409904818","owner":"51851393@N04","secret":"7d6afd4dcb","server":"7368","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"15974952834","owner":"51851393@N04","secret":"e0d2a4004b","server":"8671","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16403923490","owner":"10475669@N06","secret":"e6fafcc9cd","server":"8632","farm":9,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16405089049","owner":"10475669@N06","secret":"04eac08219","server":"8574","farm":9,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16589733991","owner":"10475669@N06","secret":"b7d02cf23d","server":"7364","farm":8,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16589731601","owner":"10475669@N06","secret":"d0a2c7df48","server":"7423","farm":8,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0}]},"stat":"ok"})`

func TestRenderHTMLForm(t *testing.T) {
	request, err := http.NewRequest("GET", "/", nil)
	if err != nil {
		t.Fatal(err)
	}
	response := httptest.NewRecorder()
	renderForm(response, request)
	if response.Code != 200 {
		t.Fatal(response.Code)
	}
	if !strings.ContainsAny(response.Body.String(), htmlSearch) {
		t.Fatal("Response not expected")
	}
}

func TestSearchTo(t *testing.T) {
	request, err := http.NewRequest("POST", "/", nil)
	if err != nil {
		t.Fatal(err)
	}

	response := httptest.NewRecorder()

	testingCall = true
	flickrResponseBody = []byte(flickrJSON)
	searchTo(response, request)

	if response.Code != 200 {
		t.Fatal(response.Code)
		return
	}

	if !strings.ContainsAny(response.Body.String(), `<img src="https://farm9.staticflickr.com/8718/17169135171_abb08a3d18_b.jpg" class="img-responsive" alt="Responsive image">`) {
		t.Fatal("Response not expected")
	}
}

func TestPOSTWhenValidJSON(t *testing.T) {
	request, err := http.NewRequest("POST", "/", nil)
	if err != nil {
		t.Fatal(err)
	}

	response := httptest.NewRecorder()

	testingCall = true
	flickrResponseBody = []byte(`{"photos":{"page":1,"pages":135,"perpage":50,"total":"6724","photo":[{"id":"24313949581","owner":"131853325@N03","secret":"b968964e51","server":"1563","farm":2,"title":"Carnaval de Barranquilla 2016: la gran fiesta de Colombia","ispublic":1,"isfriend":0,"isfamily":0},{"id":"20854464483","owner":"127055090@N04","secret":"518870eacd","server":"5772","farm":6,"title":"Bailar contigo","ispublic":1,"isfriend":0,"isfamily":0},{"id":"20852831714","owner":"127055090@N04","secret":"5e1762a16e","server":"5655","farm":6,"title":"Tu mirada","ispublic":1,"isfriend":0,"isfamily":0},{"id":"21288609569","owner":"127055090@N04","secret":"2933e73bb9","server":"717","farm":1,"title":"Young on parada","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17308805275","owner":"127055090@N04","secret":"de494b55f1","server":"7698","farm":8,"title":"Trio","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17308791505","owner":"127055090@N04","secret":"92a9b2d450","server":"7705","farm":8,"title":"Carnaval de Barranquilla","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17306929652","owner":"127055090@N04","secret":"955622a71b","server":"8787","farm":9,"title":"Pretty smile Dancer","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16547483384","owner":"131549499@N06","secret":"9a57096db5","server":"8791","farm":9,"title":"100_2320","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16962481477","owner":"131549499@N06","secret":"71a63ef393","server":"8806","farm":9,"title":"100_2318","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17143952976","owner":"131549499@N06","secret":"bdfc8616e2","server":"8744","farm":9,"title":"100_2316","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982115188","owner":"131549499@N06","secret":"9a4f8bf05f","server":"8813","farm":9,"title":"100_2314-001","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169244221","owner":"131549499@N06","secret":"9c6a5cc5c5","server":"7670","farm":8,"title":"100_2312","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169233671","owner":"131549499@N06","secret":"8aac69b655","server":"7693","farm":8,"title":"100_2311","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169220341","owner":"131549499@N06","secret":"7891fdde42","server":"7692","farm":8,"title":"100_2307","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982289690","owner":"131549499@N06","secret":"53262ff528","server":"8812","farm":9,"title":"100_2304","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16549647293","owner":"131549499@N06","secret":"3d08959f38","server":"8735","farm":9,"title":"100_2301","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17168165532","owner":"131549499@N06","secret":"71df4b207d","server":"8745","farm":9,"title":"100_2299","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982255230","owner":"131549499@N06","secret":"eababd5fa9","server":"8789","farm":9,"title":"100_2296","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16549613113","owner":"131549499@N06","secret":"3020cecf3c","server":"8768","farm":9,"title":"100_2294","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16962359017","owner":"131549499@N06","secret":"65d714b221","server":"7611","farm":8,"title":"100_2292","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982225080","owner":"131549499@N06","secret":"2a6d5b970a","server":"7717","farm":8,"title":"100_2291","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17169135171","owner":"131549499@N06","secret":"abb08a3d18","server":"8718","farm":9,"title":"100_2289","ispublic":1,"isfriend":0,"isfamily":0},{"id":"17143773966","owner":"131549499@N06","secret":"93106cd772","server":"7599","farm":8,"title":"100_2273","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16982082650","owner":"131549499@N06","secret":"4a5ac7ed86","server":"8689","farm":9,"title":"100_2306-001","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16655642650","owner":"127055090@N04","secret":"b52bccd1e3","server":"8615","farm":9,"title":"Hola guapita!","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16842713485","owner":"127055090@N04","secret":"02f251151f","server":"7283","farm":8,"title":"Public intimacy","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16577012727","owner":"127055090@N04","secret":"13b2b7b05f","server":"7606","farm":8,"title":"Muevete!","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16122121144","owner":"29903860@N05","secret":"797074b3dc","server":"8637","farm":9,"title":"Carnaval de Barranquilla","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16540452868","owner":"127055090@N04","secret":"3a95b35d25","server":"8666","farm":9,"title":"Don't you know what's coming?","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16410106100","owner":"51851393@N04","secret":"151d6fdf4d","server":"8634","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16411288549","owner":"51851393@N04","secret":"7f63a74c64","server":"7395","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16409913088","owner":"51851393@N04","secret":"6709da1026","server":"8586","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16411287649","owner":"51851393@N04","secret":"2461394412","server":"7362","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"15974960584","owner":"51851393@N04","secret":"c48fb1fa50","server":"7292","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16411286539","owner":"51851393@N04","secret":"cfeba08f36","server":"7408","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"15974959294","owner":"51851393@N04","secret":"d19250cb65","server":"7427","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16596499262","owner":"51851393@N04","secret":"d13656f728","server":"7282","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16571138196","owner":"51851393@N04","secret":"f8fa197ec2","server":"8628","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16571137626","owner":"51851393@N04","secret":"0381a3878d","server":"7288","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16571137146","owner":"51851393@N04","secret":"fe08dd8d49","server":"7375","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16595936421","owner":"51851393@N04","secret":"478b949360","server":"7423","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16595935851","owner":"51851393@N04","secret":"f915e1cc5a","server":"8566","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16597118535","owner":"51851393@N04","secret":"d8edf7c35f","server":"7339","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16596495512","owner":"51851393@N04","secret":"9710279b78","server":"7286","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16409904818","owner":"51851393@N04","secret":"7d6afd4dcb","server":"7368","farm":8,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"15974952834","owner":"51851393@N04","secret":"e0d2a4004b","server":"8671","farm":9,"title":"Carnaval de Barranquilla 2015","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16403923490","owner":"10475669@N06","secret":"e6fafcc9cd","server":"8632","farm":9,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16405089049","owner":"10475669@N06","secret":"04eac08219","server":"8574","farm":9,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16589733991","owner":"10475669@N06","secret":"b7d02cf23d","server":"7364","farm":8,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0},{"id":"16589731601","owner":"10475669@N06","secret":"d0a2c7df48","server":"7423","farm":8,"title":"Barranquilla ciudad en movimiento","ispublic":1,"isfriend":0,"isfamily":0}]},"stat":"ok"}`)
	searchTo(response, request)

	if response.Code != 200 {
		t.Fatal(response.Code)
		return
	}

	if !strings.ContainsAny(response.Body.String(), `<img src="https://farm9.staticflickr.com/8718/17169135171_abb08a3d18_b.jpg" class="img-responsive" alt="Responsive image">`) {
		t.Fatal("Response not expected")
	}
}
